<!-- Main Container -->
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <!-- Left: Review summary and list -->
    <div class="col-12 col-lg-7 mb-4 mb-lg-0">
      <!-- Review Summary Section -->
      <div class="mb-4">
        <div class="p-4">
          <div class="row align-items-center">
            <div class="col-md-4 text-center mb-3 mb-md-0">
              <div class="display-4 fw-bold text-warning">{{ averageRating | number:'1.1-1' }}</div>
              <div>
                <ng-container *ngFor="let star of [1,2,3,4,5]">
                  <i class="bi" [class.bi-star-fill]="star <= round(averageRating)" [class.bi-star]="star > round(averageRating)" [class.text-warning]="star <= round(averageRating)"></i>
                </ng-container>
              </div>
              <div class="text-muted mt-2">{{ totalReviews }} global ratings</div>
            </div>
            <div class="col-md-4">
              <div *ngFor="let s of starBreakdown" class="d-flex align-items-center mb-1">
                <span class="me-2">{{ s.star }} star</span>
                <div class="flex-grow-1 bg-light rounded-pill overflow-hidden me-2" style="height: 10px;">
                  <div class="bg-warning" [style.width.%]="s.percent" style="height: 100%;"></div>
                </div>
                <span class="text-muted small">{{ s.percent }}%</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="fw-semibold mb-2">Top reviews</div>
              <div *ngFor="let rev of topReviews" class="mb-2 pb-2 border-bottom">
                <div class="d-flex align-items-center mb-1">
                  <ng-container *ngFor="let star of [1,2,3,4,5]">
                    <i class="bi" [class.bi-star-fill]="star <= rev.rating" [class.bi-star]="star > rev.rating" [class.text-warning]="star <= rev.rating"></i>
                  </ng-container>
                  <span class="ms-2 text-muted small">User #{{ rev.userId }}</span>
                </div>
                <div class="small text-muted mb-1" *ngIf="rev.createdAt">{{ rev.createdAt | date: 'mediumDate' }}</div>
                <div>{{ rev.text }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Reviews List Section (left-aligned, no card/border) -->
      <div class="mb-4" style="max-width: 700px;">
        <h3 class="mb-4">All Reviews</h3>
        <div *ngIf="reviews.length > 0" class="reviews-list">
          <div *ngFor="let rev of reviews | slice:0:visibleReviewsCount" class="review-item mb-4 pb-4 border-bottom">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="d-flex align-items-center">
                <div class="rating-stars me-2">
                  <i *ngFor="let star of [1,2,3,4,5]" 
                     class="bi"
                     [class.bi-star-fill]="star <= rev.rating"
                     [class.bi-star]="star > rev.rating"
                     [class.text-warning]="star <= rev.rating">
                  </i>
                </div>
                <span class="text-muted small">User #{{ rev.userId }}</span>
              </div>
              <small class="text-muted">{{ rev.createdAt | date: 'medium' }}</small>
            </div>
            <div class="position-relative">
              <p class="mb-0">{{ rev.text }}</p>
              <!-- Action buttons for user's own reviews -->
              <div *ngIf="rev.userId === userId" class="review-actions position-absolute" style="right: 0; top: 0;">
                <button 
                  class="btn btn-outline-warning btn-sm me-2"
                  (click)="editReview(rev)"
                  [disabled]="loading"
                >
                  <i class="bi bi-pencil"></i>
                </button>
                <button 
                  class="btn btn-outline-danger btn-sm"
                  (click)="deleteReview(rev.reviewId)"
                  [disabled]="loading"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="text-center" *ngIf="visibleReviewsCount < reviews.length">
            <button class="btn btn-outline-primary mt-2" (click)="loadMoreReviews()">Load more reviews</button>
          </div>
        </div>
        <div *ngIf="reviews.length === 0" class="text-center text-muted py-4">
          <i class="bi bi-chat-square-text display-4"></i>
          <p class="mt-3">No reviews yet for this business.</p>
        </div>
      </div>
    </div>
    <!-- Right: Add review form -->
    <div class="col-12 col-lg-5">
      <!-- Review Form Card -->
      <div class="shadow-sm mb-4">
        <div class="card-body p-4">
          <h2 class="card-title mb-4 text-accent">
            {{ isEdit ? 'Edit Your Review' : 'Add a Review' }}
          </h2>

          <form [formGroup]="reviewForm" (ngSubmit)="onSubmit()" novalidate>
            <!-- Rating -->
            <div class="mb-4">
              <label for="rating" class="form-label fw-bold">
                Rating <span class="text-danger">*</span>
              </label>
              <div class="rating-input">
                <div class="btn-group w-100" role="group">
                  <button 
                    *ngFor="let star of [1,2,3,4,5]" 
                    type="button"
                    class="btn btn-outline-primary"
                    [class.active]="reviewForm.get('rating')?.value === star"
                    (click)="reviewForm.patchValue({rating: star})"
                  >
                    <i class="bi bi-star-fill"></i>
                  </button>
                </div>
              </div>
              <div
                *ngIf="
                  reviewForm.controls['rating'].invalid &&
                  (reviewForm.controls['rating'].dirty ||
                    reviewForm.controls['rating'].touched)
                "
                class="text-danger mt-2 small"
              >
                Please select a rating between 1 and 5.
              </div>
            </div>

            <!-- Review Text -->
            <div class="mb-4">
              <label for="text" class="form-label fw-bold">
                Your Review <span class="text-danger">*</span>
              </label>
              <textarea
                id="text"
                rows="4"
                class="form-control"
                formControlName="text"
                placeholder="Share your experience with this business..."
              ></textarea>
              <div
                *ngIf="
                  reviewForm.controls['text'].invalid &&
                  (reviewForm.controls['text'].dirty ||
                    reviewForm.controls['text'].touched)
                "
                class="text-danger mt-2 small"
              >
                <span *ngIf="reviewForm.controls['text'].errors?.['required']">
                  Review text is required.
                </span>
                <span *ngIf="reviewForm.controls['text'].errors?.['minlength']">
                  Review must be at least 5 characters.
                </span>
                <span *ngIf="reviewForm.controls['text'].errors?.['maxlength']">
                  Review cannot exceed 500 characters.
                </span>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2">
              <button
                type="submit"
                class="btn btn-accent flex-grow-1"
                [disabled]="loading || reviewForm.invalid"
              >
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                {{ isEdit ? 'Update Review' : 'Add Review' }}
              </button>

              <button
                *ngIf="isEdit && selectedReviewId"
                type="button"
                class="btn btn-outline-danger"
                [disabled]="loading"
                (click)="deleteReview()"
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
